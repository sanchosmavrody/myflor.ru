var ruLang = {
    "searchPanes": {
        title: {
            _: '<b>Выбрано фильтров - %d</b>',
            0: 'Фильтры не выбраны',
            1: '<b>Один фильтр выбран</b>'
        }
    },
    // "lengthMenu": "Показать _MENU_ строк на страницу",
    // "zeroRecords": "Пусто",
    // "info": "Страница _PAGE_ из _PAGES_",
    // "infoEmpty": "Нет записей для отображения",
    // "infoFiltered": " Найдено <b>_TOTAL_</b> (отфильтровано из _MAX_ записей)",
    "processing": "Подождите...",
    "search": "",
    "lengthMenu": "Показать _MENU_ записей",
    "info": "Записи с _START_ до _END_ из _TOTAL_ записей",
    "infoEmpty": "Записи с 0 до 0 из 0 записей",
    "infoFiltered": "(отфильтровано из _MAX_ записей)",
    "loadingRecords": "Загрузка записей...",
    "zeroRecords": "Записи отсутствуют.",
    "emptyTable": "В таблице отсутствуют данные",
    "paginate": {
        "first": "Первая",
        "previous": "Предыдущая",
        "next": "Следующая",
        "last": "Последняя"
    },
    "aria": {
        "sortAscending": ": активировать для сортировки столбца по возрастанию",
        "sortDescending": ": активировать для сортировки столбца по убыванию"
    },
    "select": {
        "rows": {
            "_": "Выбрано записей: %d",
            "1": "Выбрана одна запись"
        },
        // "cells": {
        //     "1": "1 ячейка выбрана",
        //     "_": "Выбрано %d ячеек"
        // },
        // "columns": {
        //     "1": "1 столбец выбран",
        //     "_": "%d столбцов выбрано"
        // }
    },
    "searchBuilder": {
        "conditions": {
            "string": {
                "startsWith": "Начинается с",
                "contains": "Содержит",
                "empty": "Пусто",
                "endsWith": "Заканчивается на",
                "equals": "Равно",
                "not": "Не",
                "notEmpty": "Не пусто",
                "notContains": "Не содержит",
                "notStarts": "Не начинается на",
                "notEnds": "Не заканчивается на"
            },
            "date": {
                "after": "После",
                "before": "До",
                "between": "Между",
                "empty": "Пусто",
                "equals": "Равно",
                "not": "Не",
                "notBetween": "Не между",
                "notEmpty": "Не пусто"
            },
            "number": {
                "empty": "Пусто",
                "equals": "Равно",
                "gt": "Больше чем",
                "gte": "Больше, чем равно",
                "lt": "Меньше чем",
                "lte": "Меньше, чем равно",
                "not": "Не",
                "notEmpty": "Не пусто",
                "between": "Между",
                "notBetween": "Не между ними"
            },
            "array": {
                "equals": "Равно",
                "empty": "Пусто",
                "contains": "Содержит",
                "not": "Не равно",
                "notEmpty": "Не пусто",
                "without": "Без"
            }
        },
        "data": "Данные",
        "deleteTitle": "Удалить условие фильтрации",
        "logicAnd": "И",
        "logicOr": "Или",
        "title": {
            "0": "Конструктор поиска",
            "_": "Конструктор поиска (%d)"
        },
        "value": "Значение",
        "add": "Добавить условие",
        "button": {
            "0": "Конструктор поиска",
            "_": "Конструктор поиска (%d)"
        },
        "clearAll": "Очистить всё",
        "condition": "Условие",
        "leftTitle": "Превосходные критерии",
        "rightTitle": "Критерии отступа"
    },
    "searchPanes": {
        "clearMessage": "Очистить всё",
        "collapse": {
            "0": "Панели поиска",
            "_": "Панели поиска (%d)"
        },
        "count": "{total}",
        "countFiltered": "{shown} ({total})",
        "emptyPanes": "Нет панелей поиска",
        "loadMessage": "Загрузка панелей поиска",
        "title": "Фильтры активны - %d",
        "showMessage": "Показать все",
        "collapseMessage": "Скрыть все"
    },
    "thousands": ",",
    "buttons": {
        "pageLength": {
            "_": "Показать 10 строк",
            "-1": "Показать все ряды"
        },
        "pdf": "PDF",
        "print": "Печать",
        "collection": "Коллекция <span class=\"ui-button-icon-primary ui-icon ui-icon-triangle-1-s\"><\/span>",
        "colvis": "Видимость столбцов",
        "colvisRestore": "Восстановить видимость",
        "copy": "Копировать",
        "copyKeys": "Нажмите ctrl or u2318 + C, чтобы скопировать данные таблицы в буфер обмена.  Для отмены, щелкните по сообщению или нажмите escape.",
        "copySuccess": {
            "1": "Скопирована 1 ряд в буфер обмена",
            "_": "Скопировано %ds рядов в буфер обмена"
        },
        "copyTitle": "Скопировать в буфер обмена",
        "csv": "CSV",
        "excel": "Excel"
    },
    "decimal": ".",
    "infoThousands": ",",
    "autoFill": {
        "cancel": "Отменить",
        "fill": "Заполнить все ячейки <i>%d<i><\/i><\/i>",
        "fillHorizontal": "Заполнить ячейки по горизонтали",
        "fillVertical": "Заполнить ячейки по вертикали"
    },
    "datetime": {
        "previous": "Предыдущий",
        "next": "Следующий",
        "hours": "Часы",
        "minutes": "Минуты",
        "seconds": "Секунды",
        "unknown": "Неизвестный",
        "amPm": [
            "AM",
            "PM"
        ],
        "months": {
            "0": "Январь",
            "1": "Февраль",
            "10": "Ноябрь",
            "11": "Декабрь",
            "2": "Март",
            "3": "Апрель",
            "4": "Май",
            "5": "Июнь",
            "6": "Июль",
            "7": "Август",
            "8": "Сентябрь",
            "9": "Октябрь"
        },
        "weekdays": [
            "Вс",
            "Пн",
            "Вт",
            "Ср",
            "Чт",
            "Пт",
            "Сб"
        ]
    },
    "editor": {
        "close": "Закрыть",
        "create": {
            "button": "Новый",
            "title": "Создать новую запись",
            "submit": "Создать"
        },
        "edit": {
            "button": "Изменить",
            "title": "Изменить запись",
            "submit": "Изменить"
        },
        "remove": {
            "button": "Удалить",
            "title": "Удалить",
            "submit": "Удалить",
            "confirm": {
                "_": "Вы точно хотите удалить %d строк?",
                "1": "Вы точно хотите удалить 1 строку?"
            }
        },
        "multi": {
            "restore": "Отменить изменения",
            "title": "Несколько значений",
            "noMulti": "Это поле должно редактироватся отдельно, а не как часть групы"
        },
        "error": {
            "system": "Возникла системная ошибка (<a target=\"\\\" rel=\"nofollow\" href=\"\\\">Подробнее<\/a>)"
        }
    },
    "searchPlaceholder": "Что ищете?"
};


function copyToClipboard(element) {
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val($(element).text()).select();
    document.execCommand("copy");
    $temp.remove();
}

window.mobileCheck = function () {
    let check = false;
    (function (a) {
        if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
    })(navigator.userAgent || navigator.vendor || window.opera);
    return check;
};

var table = false
$(document).ready(function () {

    var isMobile = mobileCheck();

    $('body').addClass('isMobile');

    function findGetParameter(parameterName) {
        var result = null,
            tmp = [];
        var items = location.search.substr(1).split("&");
        for (var index = 0; index < items.length; index++) {
            tmp = items[index].split("=");
            if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        }
        return result;
    }

    var mod = findGetParameter('mod');
    if (mod == null)
        mod = defModule;

    var ids = findGetParameter('ids');

    function getFilterUrl(filterClass = '') {
        var urlFilter = ''
        $('#filters .form-control' + filterClass).each(function () {
            if ($(this).val())
                urlFilter += '&' + $(this).attr('name') + '=' + $(this).val()
        })
        return urlFilter
    }

    function getStats() {
        $.getJSON('/engine/ajax/index.php?mod=' + mod + '&act=getStats', function (stats) {

            $('.btn-toolbar').html('')
            $.each(stats, function (i, stata) {
                if (stata['val'])
                    $('.btn-toolbar').append(`
        <div class="btn-group mr-2" role="group" aria-label="First group">
            <button type="button" class="btn btn-outline-secondary">${stata['label']}</button>
            <button type="button" class="btn btn-secondary">${stata['val']}</button>
        </div>
        `);
                if (stata['url'])
                    $('.btn-toolbar').append(`
        <div class="btn-group mr-2" role="group" aria-label="First group">
            <a target="_blank" href="${stata['url']}" type="button" class="btn btn-outline-secondary">${stata['label']}</a>
        </div>
        `);
            })


        });
    }

    getStats();

    const FILTERS = (filters) => {
        $.each(filters, function (field, filter) {
            $('#filters').append(`<div class="ml-1" style="float: left"><select multiple name="filter[${field}]" class="form-control form-control-sm float-left" style="min-width: 200px"><option value="">${filter['des']} - Все</option></select></div>`)
            $.each(filter.list, function (i, item) {
                $('#filters [name="filter[' + field + ']"]').append(`<option value="${item['value']}">${item['name']} (${item['count']})</option>`)
            })

            if (localStorage.getItem("_" + field))
                $('#filters [name="filter[' + field + ']"]').val(localStorage.getItem("_" + field))
            $('#filters [name="filter[' + field + ']"]').change(function () {
                localStorage.setItem("_" + field, $(this).val())
                if (table)
                    table.ajax.url('/engine/ajax/index.php?mod=' + mod + '&act=data&serverside=1' + getFilterUrl()).draw()
            })

            $('#filters [name="filter[' + field + ']"]').select2({placeholder:filter.des})
        })
    }

    const FILTERS_Car = (filters) => {
        // let filters = ['carBrand', 'carModel', 'carV', 'carP', 'carP'];
        $.each(filters, function (field, filter) {
            if (!$('#filters [name="filter[car][' + field + ']"]').length) {
                $('#filters').append(`<div class="ml-1" style="float: left"><select id="select_car_${field}" name="filter[car][${field}]" class="form-control form-control-sm float-left cars" style="width: 200px"><option value="">${filter['des']} - Все</option></select></div>`)
                $('#filters [name="filter[car][' + field + ']"]').change(function () {

                    $.getJSON('/engine/ajax/index.php?mod=catalog_applicability&act=getFilters' + getFilterUrl('.cars') + '&fieldSelected=' + field, function (filters_) {
                        FILTERS_Car(filters_['filters'])
                    })

                    if (table)
                        table.ajax.url('/engine/ajax/index.php?mod=' + mod + '&act=data&serverside=1' + getFilterUrl()).draw()
                })

            }

            if (filter.listClear)
                $('#filters [name="filter[car][' + field + ']"]').html(`<option value="">${filter['des']} - Все</option></select>`)

            $.each(filter.list, function (i, item) {
                $('#filters [name="filter[car][' + field + ']"]').append(`<option value="${item['value']}">${item['name']}</option>`)
            })

            if (filter.listClear && filter.list.length === 0)
                $('#filters [name="filter[car][' + field + ']"]').hide()
            else
                $('#filters [name="filter[car][' + field + ']"]').show()

        })
    }

    function getOrdering(columns_, orderDef = [0, 'asc']) {
        var colI = 0;
        columns_.map(function (column) {
            if (column['order'])
                orderDef = [colI, column['order']]
            colI++;
        });
        return [orderDef];
    }

    const TABLE = (columns_) => {
        var partUrl_ids = '';
        if (mod !== null)
            partUrl_ids = '&ids=' + ids;
        if (mod == 'store_ostatok') {
            if (isMobile)
                $('#mainTable').DataTable({
                    searchHighlight: true,
                    order: [[6, 'asc']],
                    select: true,
                    dom: 'fti', //Pfrtip
                    searchPanes: false,
                    columnDefs: [
                        {
                            visible: false,
                            targets: [2]
                        }
                    ],
                    "pageLength": -1,
                    "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
                    scrollY: $(window.top).height() - 300,
                    "responsive": true,
                    "ajax": '/engine/ajax/index.php?mod=' + mod + '&act=data' + partUrl_ids,
                    "language": ruLang,
                    "columns": columns_
                });
            else $('#mainTable').DataTable({
                searchHighlight: true,
                order: [[6, 'asc']],
                select: true,
                dom: 'fPti', //Pfrtip
                searchPanes: {
                    layout: 'columns-6',
                    initCollapsed: true,
                    cascadePanes: true,
                    viewTotal: true,
                    //   clear: false
                },
                columnDefs: [
                    {
                        searchPanes: {
                            layout: 'columns-6',
                            initCollapsed: true,
                            show: true
                        },
                        targets: [2, 3, 4, 5, 6, 7]
                    }, {
                        searchPanes: {
                            show: false
                        },
                        targets: [0, 1, 6, 8, 9, 10, 11, 12, 13]
                    }, {
                        searchPanes: {
                            show: true
                        },
                        visible: false,
                        targets: [2]
                    }
                ],

                //rowGroup: {
                //    startRender: function (rows, group) {
                //        return group + ' (' + rows.count() + ')';
                //    },
                //    endRender: null,
                //    dataSrc: 'col_3'
                //},
                "pageLength": -1,
                "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
                scrollY: $(window.top).height() - 300,
                "responsive": true,
                "ajax": '/engine/ajax/index.php?mod=' + mod + '&act=data' + partUrl_ids,
                "language": ruLang,
                "columns": columns_
            });
        } else if (mod == 'store_catalog') {
            table = $('#mainTable').DataTable({
                searchHighlight: true,
                order: [[0, 'asc']],
                select: true,
                dom: 'fPti', //Pfrtip
                searchPanes: {
                    layout: 'columns-2',
                    initCollapsed: true,
                    cascadePanes: true,
                    viewTotal: true,
                    //   clear: false
                },
                columnDefs: [
                    {
                        searchPanes: {
                            layout: 'columns-4',
                            initCollapsed: true,
                            show: true
                        },
                        targets: [2]
                    }, {
                        searchPanes: {
                            show: false
                        },
                        targets: [0, 1, 3, 4]
                    }, {
                        visible: false,
                        targets: [2]
                    }
                ],

                //rowGroup: {
                //    startRender: function (rows, group) {
                //        return group + ' (' + rows.count() + ')';
                //    },
                //    endRender: null,
                //    dataSrc: 'col_3'
                //},
                "pageLength": -1,
                "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
                scrollY: $(window.top).height() - 100,
                "responsive": true,
                "ajax": '/engine/ajax/index.php?mod=' + mod + '&act=data',
                "language": ruLang,
                "columns": columns_
            });
        } else if (mod == 'catalog_nomenclature') {
            var ajax = '/engine/ajax/index.php?mod=' + mod + '&act=data' + ($('#mainTable').data('ajax-mode') ? '&serverside=1' + getFilterUrl() : '')
            table = $('#mainTable').DataTable({
                searchHighlight: true,
                order: [[5, 'asc']],
                select: true,
                dom: 'frtip', //Pfrtip  //fPtip
                searchPanes_: {
                    layout: 'columns-2',
                    initCollapsed: true,
                    cascadePanes: true,
                    viewTotal: true,
                    //   clear: false
                },
                columnDefs_: [
                    {
                        searchPanes: {
                            layout: 'columns-4',
                            initCollapsed: true,
                            show: true
                        },
                        targets: [5, 3]
                    }, {
                        searchPanes: {
                            show: false
                        },
                        targets: [0, 1, 2, 3, 4]
                    },
                ],
                pageLength: $('#mainTable').data('ajax-mode') ? 100 : -1,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                scrollY: $(window.top).height() - 200,
                "responsive": true,
                ajax,
                "language": ruLang,
                "columns": columns_,
                processing: $('#mainTable').data('ajax-mode') ? true : false,
                serverSide: $('#mainTable').data('ajax-mode') ? true : false,
            });
        } else {
            //ДЕФОЛТ

            var mod_ = location.search;
            if (mod_ === '')
                mod_ = '?mod=' + defModule;
            var ajax = '/engine/ajax/index.php' + mod_ + '&act=data' + ($('#mainTable').data('ajax-mode') ? '&serverside=1' + getFilterUrl() : '')
            var rowGroup = false
            if ($('#mainTable').data('group-field'))
                rowGroup = {
                    startRender: function (rows, group) {
                        return group + ' (' + rows.count() + ')'
                    },
                    endRender: null,
                    dataSrc: $('#mainTable').data('group-field')
                }

            table = $('#mainTable').DataTable({
                searchHighlight: true,
                order: getOrdering(columns_),
                select: true,
                // dom: 'fti', //Pfrtip
                dom: 'frtip',
                searchPanes: false,
                rowGroup,
                pageLength: $('#mainTable').data('ajax-mode') ? 100 : -1,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                scrollY: $(window.top).height() - 300,
                "responsive": true,
                ajax,
                "language": ruLang,
                "columns": columns_,
                processing: $('#mainTable').data('ajax-mode') ? true : false,
                serverSide: $('#mainTable').data('ajax-mode') ? true : false,
            })
        }
    }

    $.getJSON('/engine/ajax/index.php?mod=' + mod + '&act=getFilters', function (res) {
        if (res['filters'] && Object.keys(res['filters']).length)
            FILTERS(res['filters'])

        $.getJSON('/engine/ajax/index.php?mod=' + mod + '&act=columnsTable', function (columns_) {
            TABLE(columns_)
        });
    });

    if (window.location.href.split('mod=').length > 1 && ['catalog_nomenclature', 'catalog_applicability', 'store_price'].indexOf(window.location.href.split('mod=')[1]) > -1)
        $.getJSON('/engine/ajax/index.php?mod=catalog_applicability&act=getFilters' + getFilterUrl('.cars'), function (filters) {
            FILTERS_Car(filters['filters'])
        });

    $('body').on('click', '.btnEdit', function () {
        var id = $(this).closest('tr').find('td:eq(1)').text();
        console.log('btnEdit id', id);

        $('#form_edit [name="id"]').val(id);
        $('#form_edit .item_id').text(id);
        $.getJSON('/engine/ajax/index.php?mod=' + mod + '&act=formTable&type=edit&id=' + id, function (columns_) {
            if (columns_['columns'])
                formGenerator.init($('#form_edit .formGenerator'), columns_['columns']);
            else
                formGenerator.init($('#form_edit .formGenerator'), columns_);
        });

    });


    var imagesPreview = function (input, placeToInsertImagePreview) {

        $(placeToInsertImagePreview).html('');
        if (input.files) {
            var filesAmount = input.files.length;
            for (i = 0; i < filesAmount; i++) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    $(placeToInsertImagePreview).append(`  <div class="itimg"><img src="${event.target.result}"/></div> `);
                }
                reader.readAsDataURL(input.files[i]);
            }
        }
    };

    $('body').on('change', '#loadPhoto', function () {
        imagesPreview(this, 'div.galleryPreload');
    });


    $('body').on('click', '.copyClip', function () {
        copyToClipboard(this);
    });


    function basket(action, params, callback = function () {
    }) {
        params = new URLSearchParams(params).toString();
        $.getJSON('/engine/ajax/index.php?mod=store_basket&act=' + action + '&' + params, callback);
    }


    $('body').on('click', '.basketControl .btn', function () {
        var ctx = $(this);
        var basketControl = $(this).closest('.basketControl');
        var action = 'add';
        if ($(ctx).hasClass('btn-outline-danger'))  //уже лежит в корзине
            action = 'remove';

        basket(action, {
            'id': $(this).data('id'),
            'price': $(this).data('price'),
            'amount': $(basketControl).find('input').val(),
            'nomenclature_id': $(this).data('nomenclature_id')
        }, function () {
            getStats();
            if (action == 'remove') { //уже лежит в корзине
                $(ctx).removeClass('btn-outline-danger').addClass('btn-outline-default')
                $(basketControl).removeClass('inBasket')
                action = 'remove'
            } else {
                $(ctx).removeClass('btn-outline-default').addClass('btn-outline-danger')
                $(basketControl).addClass('inBasket')
                $(basketControl).find('input').focus().val('').val('1')
            }
        })
    });

    $('body').on('change', '.basketControl input', function () {
        if ($(this).val() !== '' && $(this).val() > 0)
            basket('change', {
                'id': $(this).data('id'),
                'amount': $(this).val(),
                'nomenclature_id': $(this).data('nomenclature_id')
            }, getStats)
    });

    $('body').on('change', '.priceBasketControl input', function () {
        if ($(this).val() !== '' && $(this).val() > 0)
            basket('changePrice', {
                'id': $(this).data('id'),
                'price': $(this).val()
            }, getStats)
    });

    $('#form_add, #form_edit').attr('action', '/engine/ajax/index.php?mod=' + mod);

    //addFormGenerator
    $.getJSON('/engine/ajax/index.php?mod=' + mod + '&act=formTable', function (columns_) {
        console.log(columns_)
        if (columns_['columns'])
            formGenerator.init($('#form_add .formGenerator'), columns_['columns']);
        else
            formGenerator.init($('#form_add .formGenerator'), columns_);
    });

    $('#form_edit, #form_add').submit(function (e) {
        var ctx = this;
        if ($(ctx).find('input.ajax').prop('checked')) {
            e.preventDefault();
            var data = $(ctx).serialize() + '&submit=' + $(ctx).find('button[name="submit"]').val();
            $.post($(this).attr('action'), data, function (res) {
                $(ctx).closest('.modal').modal('hide');
            });
        }
    });

    var formGenerator = {
        init: function (selector, fieldData) {
            console.log(fieldData)
            selector.html('');
            $.each(fieldData, function (i, field) {
                if (field['show_form'] > 0)
                    if (field['column_name'] != 'id' && typeof formGenerator['_' + field['form_type']] == 'function')
                        selector.append(formGenerator['_' + field['form_type']](field['title'], field['column_name'],
                            field['val'], field['title'], (field['show_form'] == 2 ? true : false), field['selectList']));
            });
        },
        _password: function (label, name, val, placeholder = '', disabled = false) {
            if (val === false)
                val = '';
            if (disabled)
                disabled = 'disabled="disabled"'
            return `
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label" for="exampleInputPassword1">${label}</label>
                        <div class="col-sm-10"><input ${disabled} name="${name}" value="${val}" type="password" class="form-control" id="exampleInputPassword1" placeholder="${placeholder}"></div>
                    </div>
                `;
        },
        _img: function (label, name, val, placeholder = '') {
            if (val === false || val == null || val == '')
                val = [];
            else
                val = val.split(',');
            var gallery = [];

            let id = 0

            $.each(val, function (key, item) {
                item = item.split('|')
                if (item.length > 1) {
                    id = item[0]
                    item = item[1]
                } else {
                    item = item[0]
                    id = ''
                }

                gallery.push(`
                    <div class="itimg"><img src="${item}"/><input name="${name}[]" type="hidden" value="${id}"/>
                    <i onclick="$(this).closest('.itimg').prev().insertAfter($(this).closest('.itimg'))" class="fa fa-chevron-left"></i>
                    <i class="fa fa-trash" onclick="$(this).closest('.itimg').remove()"></i>
                    </div>
                `);
            });

            return `
<div class="form-group ">
    <label class=" col-form-label" for="exampleInputPassword1">${label}</label>
                <button class="btn btn-xs btn-default upload-btn-wrapper"><i class="fa fa-camera-retro"></i>
                <input type="file" id="loadPhoto" name="${name}_upload[]" multiple accept=".mp4, .jpg, .jpeg, .png, .doc, .docx, application/pdf">
            </button>
            <hr>
    <div class="gallery">${gallery.join('')}</div>
    <div class="galleryPreload"></div>
  
</div>
`;
        },
        _input: function (label, name, val, placeholder = '', disabled = false) {
            if (val === false)
                val = '';
            if (disabled)
                return `
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label"><b>${label}</b></label>
                        <div class="col-sm-10">
                        <input name="${name}" value="${val}" type="hidden">
                        <input disabled="disabled" value="${val}" type="text" class="form-control form-control-sm"></div>
                    </div>
                `;
            else
                return `
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label"><b>${label}</b></label>
                        <div class="col-sm-10"><input ${disabled} name="${name}" value="${val}" type="text" class="form-control form-control-sm" placeholder="${placeholder}"></div>
                    </div>
                `;
        },
        _date: function (label, name, val, placeholder = '', disabled = false) {
            if (val === false)
                val = '';
            return `
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label" for="exampleInputPassword1"><b>${label}</b></label>
                        <div class="col-sm-10"><input name="${name}" value="${val}" type="date" class="form-control" id="exampleInputPassword1" placeholder="${placeholder}"></div>
                    </div>
                `;
        },
        _select: function (label, name, val, placeholder = '', disabled = false, selectList) {
            if (val === false)
                val = '';

            var optionsHtml = '<option  value="">-</option>';
            $.each(selectList, function (i, item) {
                if (val === item)
                    optionsHtml += `<option selected="selected" value="${item}">${item}</option>`;
                else
                    optionsHtml += `<option value="${item}">${item}</option>`;
            })
            return `
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label" ><b>${label}</b></label>
                        <div class="col-sm-10"><select name="${name}" type="text" class="form-control">${optionsHtml}</select></div>
                    </div>
                `;
        },
        _selectTable: function (label, name, val, placeholder = '', disabled = false, selectList) {
            if (val === false)
                val = '';

            var optionsHtml = '<option  value="">-</option>';
            $.each(selectList, function (i, item) {
                if (val === item['value'])
                    optionsHtml += `<option selected="selected" value="${item['value']}">${item['name']}</option>`;
                else
                    optionsHtml += `<option value="${item['value']}">${item['name']}</option>`;
            })
            return `
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label" ><b>${label}</b></label>
                        <div class="col-sm-10"><select name="${name}" type="text" class="form-control">${optionsHtml}</select></div>
                    </div>
                `;
        },
        _selectCreate: function (label, name, val, placeholder = '') {
            if (val === false)
                val = '';
            return `
                    <div class="form-group row">
                        <label class="col-sm-2 col-form-label" for="exampleInputPassword1">${label}</label>
                        <div class="col-sm-10"><input name="${name}" value="${val}" type="text" class="form-control" id="exampleInputPassword1" placeholder="${placeholder}"></div>
                    </div>
                `;
        },
        _text: function (label, name, val, placeholder = '') {
            if (val === false)
                val = '';
            return `
                    <div class="form-group ">
                        <label class="col-form-label" for="exampleInputPassword1"><b>${label}</b></label>
                        <textarea  name="${name}"  class="form-control"  placeholder="${placeholder}" >${val}</textarea>
                    </div>
                `;
        },
        _showLog: function (label, name, val, placeholder = '') {
            if (val === false)
                val = '';
            return `
                    <div class="form-group ">
                        <label class="col-form-label" for="exampleInputPassword1">${label}</label>
                        <textarea  name="${name}"  class="form-control"  placeholder="${placeholder}" >${val}</textarea>
                    </div>
                `;
        },
        _list: function (label, name, val, placeholder = '') {
            if (val === false)
                val = [];
            let items = val.map(function (item) {
                return `<li>${item}</li>`
            })
            items = items.join('');
            return `
                    <div class="form-group ">
                        <label class="col-form-label" for="">${label}</label>
                        <ul class="list-group">${items}</ul>
                   </div>
                `;
        },
        _table: function (label, name, rows, placeholder = '') {
            if (rows === false)
                rows = [];
            console.log(label, name, rows)
            let items = [];
            rows.map(function (row) {
                items.push('<tr>')
                row.map(function (val) {
                    items.push('<td>' + val + '</td>')
                })
                items.push('</tr>')
            })
            items = items.join('')
            return `<div class="form-group">
                        <label class="col-form-label" ><b>${label}</b></label>
                        
                        <table class="table table-striped">${items}</table>
                    </div>`;
        },
        _grid: function (label, name, rows, placeholder = '') {
            if (rows === false)
                rows = [];
            console.log(label, name, rows)
            let items = [];
            rows.map(function (row) {

                row.map(function (val) {
                    items.push('<td>' + val + '</td>')
                })

            })
            items = items.join('')
            return `<div class="form-group">
                        <label class="col-form-label" ><b>${label}</b></label>
                        <div class="_grid">${items}</div>
                    </div>`;
        },


    }


    setInterval(function () {

        $.getJSON('/engine/ajax/index.php?mod=' + mod + '&act=getUnread', function (data) {

            if (data.count > 0) {
                beep(600, 600)
                setTimeout(function () {
                    beep(600, 700)
                }, 1000)
                setTimeout(function () {
                    beep(600, 800)
                }, 2000)
            }
        });
    }, 60000)
});


jQuery.extend({
    highlight: function (node, re, nodeName, className) {
        if (node.nodeType === 3) {
            var match = node.data.match(re);
            if (match) {
                var highlight = document.createElement(nodeName || 'span');
                highlight.className = className || 'highlight';
                var wordNode = node.splitText(match.index);
                wordNode.splitText(match[0].length);
                var wordClone = wordNode.cloneNode(true);
                highlight.appendChild(wordClone);
                wordNode.parentNode.replaceChild(highlight, wordNode);
                return 1; //skip added node in parent
            }
        } else if ((node.nodeType === 1 && node.childNodes) && // only element nodes that have children
            !/(script|style)/i.test(node.tagName) && // ignore script and style nodes
            !(node.tagName === nodeName.toUpperCase() && node.className === className)) { // skip if already highlighted
            for (var i = 0; i < node.childNodes.length; i++) {
                i += jQuery.highlight(node.childNodes[i], re, nodeName, className);
            }
        }
        return 0;
    }
});

jQuery.fn.unhighlight = function (options) {
    var settings = {className: 'highlight', element: 'span'};
    jQuery.extend(settings, options);

    return this.find(settings.element + "." + settings.className).each(function () {
        var parent = this.parentNode;
        parent.replaceChild(this.firstChild, this);
        parent.normalize();
    }).end();
};

jQuery.fn.highlight = function (words, options) {
    var settings = {className: 'highlight', element: 'span', caseSensitive: false, wordsOnly: false};
    jQuery.extend(settings, options);

    if (words.constructor === String) {
        words = [words];
    }
    words = jQuery.grep(words, function (word, i) {
        return word != '';
    });
    words = jQuery.map(words, function (word, i) {
        return word.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&");
    });
    if (words.length == 0) {
        return this;
    }
    ;

    var flag = settings.caseSensitive ? "" : "i";
    var pattern = "(" + words.join("|") + ")";
    if (settings.wordsOnly) {
        pattern = "\\b" + pattern + "\\b";
    }
    var re = new RegExp(pattern, flag);

    return this.each(function () {
        jQuery.highlight(this, re, settings.element, settings.className);
    });
};


function request_ajax_file_v2(ajax_url, ajax_data, ajax_progress, ajax_success) {

    jQuery.ajax({
        url: ajax_url,
        data: ajax_data,
        type: 'POST',
        processData: false,
        contentType: false,
        xhrFields: {
            withCredentials: true
        },
        success: function (res) {
            ajax_success(res);
        },
        xhr: function () {
            var myXhr = $.ajaxSettings.xhr();
            var current_progress = 0;
            if (myXhr.upload) {
                // For handling the progress of the upload
                myXhr.upload.addEventListener('progress', function (e) {
                    if (e.lengthComputable) {
                        current_progress = 100 * e.loaded / e.total;
                        ajax_progress(current_progress);
                    }
                }, false);
            }
            return myXhr;
        }
    });
}


/**
 * @param {number} duration Длительность воспроизведения звука
 * @param {number} frequency Частота звука
 * @param {number} volume Громкость воспроизведения звука
 * @param {string} type Тип осцилятора
 * @param {function} callback Функция асинхронного возврата
 */
function beep(duration, frequency, volume, type, callback) {

    const audioCtx = new (window.AudioContext || window.webkitAudioContext || window.audioContext);

    var oscillator = audioCtx.createOscillator();
    var gainNode = audioCtx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    if (volume) {
        gainNode.gain.value = volume;
    }
    if (frequency) {
        oscillator.frequency.value = frequency;
    }
    if (type) {
        oscillator.type = type;
    }
    if (callback) {
        oscillator.onended = callback;
    }

    oscillator.start(audioCtx.currentTime);
    oscillator.stop(audioCtx.currentTime + ((duration || 500) / 1000));
};
